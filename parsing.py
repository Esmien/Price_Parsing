import re
from bs4 import BeautifulSoup

from models import Product

class TextExtractor:
    """–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –æ—á–∏—Å—Ç–∫—É HTML –∏ –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –µ–≥–æ –≤ —Ç–µ–∫—Å—Ç"""
    
    @staticmethod
    def html_to_text(html: str) -> str | None:
        """
        –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ—Ç –∏–∑ HTML –≤–µ—Å—å –Ω—É–∂–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
        
        :param html: html-–∫–æ–¥ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
        :return: –∏—Å–∫–æ–º—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç—Ä–æ—á–Ω–æ
        """
        soup = BeautifulSoup(html, 'lxml') # —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π –≤ —Å–µ–±–µ —Ö—Ä–∞–Ω–∏—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ html-—Å—Ç—Ä–∞–Ω–∏—Ü—ã
        div = soup.find('div', class_='tgme_widget_message_text') # –∏—â–µ—Ç —Ç–µ–∫—Å—Ç –≤ –±–ª–æ–∫–∞—Ö div class tgme_...
        
        if not div: # –µ—Å–ª–∏ –Ω–µ—Ç div - —Å–æ—Ä—è–Ω, –Ω–µ —Å–µ–≥–æ–¥–Ω—è
            return None
            
        # –ó–∞–º–µ–Ω—è–µ–º <br> –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
        for br in div.find_all('br'): # –∏—â–µ—Ç –í–°–ï br(–≤–∞—Ä–∏–∞–Ω—Ç \n –Ω–∞ —è–∑—ã–∫–µ —Ö—Ç–º–ª)
            br.replace_with('\n') # –Ω—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–º–µ–Ω–∞
            
        return div.get_text(separator='\n', strip=True) # –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç—Ä–æ—á–Ω–æ, —Ç–∞–∫, –∫–∞–∫ –æ–Ω –±—ã–ª –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ, —É–∂–µ –±–µ–∑ —Ç–µ–≥–æ–≤

    @staticmethod
    def convert_emoji_to_latin(text: str) -> str:
        """
        –ò—â–µ—Ç —Ñ–ª–∞–≥-—ç–º–æ–¥–∑–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ
        """
        # –ò—â–µ–º Unicode-—Ñ–ª–∞–≥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä üá¶üá™)
        match = re.search(r'[\U0001F1E6-\U0001F1FF]{2}', text) # –∏—â–µ—Ç —á–∞—Å—Ç—å —Å—Ç—Ä–æ–∫–∏ text –¥–ª–∏–Ω–Ω–æ–π 2 —Å–∏–º–≤–æ–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –≤ —ç—Ç–æ–º —Å—Ç—Ä–∞—à–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ –∫–æ–¥–∞ utf-8
        if match: # –µ—Å–ª–∏ –Ω–∞—à–µ–ª
            flag_char = match.group(0) # –∑–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ, —á—Ç–æ –Ω–∞—à–µ–ª, –∫–∞–∫ —Ñ–ª–∞–≥
            return flag_char
        return "" # –µ—Å–ª–∏ –Ω–µ –Ω–∞—à–µ–ª, —Ç–æ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

class PriceParser:
    """–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞: –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –≤ —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤"""
    
    def parse(self, raw_text: str) -> list[Product]:
        """
        –ü–æ—Å—Ç—Ä–æ—á–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç, –ø—Ä–æ–≤–µ—Ä—è—è –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–∞–∂–¥—É—é —Å—Ç—Ä–æ—á–∫—É        
        :param raw_text: '–≥—Ä—è–∑–Ω—ã–π' —Ç–µ–∫—Å—Ç, —Å –Ω–µ–Ω—É–∂–Ω—ã–º–∏ —Å–∏–º–≤–æ–ª–∞–º–∏ –∏ –Ω–µ–æ–¥–Ω–æ—Ä–æ–¥–Ω—ã–π
        :return: —Å–ø–∏—Å–æ–∫ '—á–∏—Å—Ç—ã—Ö' –∑–∞–ø–∏—Å–µ–π –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã(–Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω–∞, —Ñ–ª–∞–≥, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π) –≤ –≤–∏–¥–µ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –¥–∞—Ç–∞–∫–ª–∞—Å—Å–∞
        """
        lines = raw_text.split('\n') # —Å–æ–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ —Å–ø–∏—Å–æ–∫. 1 —Å—Ç—Ä–æ–∫–∞ - 1 —ç–ª–µ–º–µ–Ω—Ç —Å–ø–∏—Å–∫–∞
        products = [] # –æ–±—ä—è–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–∞—Ç–∞–∫–ª–∞—Å—Å–∞(—á–∏—Å—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π)
        pending_flag = "" # –ë—É—Ñ–µ—Ä –¥–ª—è —Ñ–ª–∞–≥–∞ —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å—Ç—Ä–æ–∫–∏

        for line in lines:
            line = line.strip()
            if not line: continue

            price_data = self._extract_price(line) # –∫–æ—Ä—Ç–µ–∂ –≤–∏–¥–∞ —Ü–µ–Ω–∞, –∏–º—è, –∫–æ–º–º–µ–Ω—Ç. –õ–∏–±–æ None, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç

            if price_data: # –µ—Å–ª–∏ –≤—Å–µ —Ç–∞–∫–∏ –ø–æ–¥–æ—à–ª–æ
                # –ù–∞—à–ª–∏ —Å—Ç—Ä–æ–∫—É —Å —Ü–µ–Ω–æ–π -> —ç—Ç–æ —Ç–æ–≤–∞—Ä
                price, name_part, comment_part = price_data # —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º —ç—Ç–æ—Ç –∫–æ—Ä—Ç–µ–∂ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–ª–∞–≥ (–∏–∑ –±—É—Ñ–µ—Ä–∞ –∏–ª–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏)
                flag = self._resolve_flag(name_part, comment_part, pending_flag)
                
                # –ß–∏—Å—Ç–∏–º —Ç–µ–∫—Å—Ç
                name_clean = self._clean_text(name_part)
                comment_clean = self._clean_text(comment_part).lstrip('*)').strip()

                products.append(Product( # –¥–æ–±–∞–≤–ª—è–µ–º –≥–æ—Ç–æ–≤—É—é, —á–∏—Å—Ç—É—é –∑–∞–ø–∏—Å—å –≤ —Å–ø–∏—Å–æ–∫ –∫–∞–∫ —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–∞—Ç–∞–∫–ª–∞—Å—Å–∞ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
                    name=name_clean,
                    price=price,
                    flag=flag,
                    comment=comment_clean
                ))
                
                # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –±—É—Ñ–µ—Ä
                pending_flag = "" 
            else:
                # –°—Ç—Ä–æ–∫–∞ –±–µ–∑ —Ü–µ–Ω—ã -> –≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –æ–¥–∏–Ω–æ–∫–∏–π —Ñ–ª–∞–≥
                found_flag = TextExtractor.convert_emoji_to_latin(line)
                # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –∫–æ—Ä–æ—Ç–∫–∞—è –∏ —ç—Ç–æ —Ñ–ª–∞–≥ -> –∑–∞–ø–æ–º–∏–Ω–∞–µ–º
                if found_flag and len(line) < 10:
                    pending_flag = found_flag

        return products

    def _extract_price(self, line: str) -> tuple[int, str, str] | None:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (—Ü–µ–Ω–∞, –∏–º—è, –∫–æ–º–º–µ–Ω—Ç) –∏–ª–∏ None
        :param line: '–≥—Ä—è–∑–Ω–∞—è' —Å—Ç—Ä–æ–∫–∞
        """
        clean_line = line.replace('*', '') # —É–¥–∞–ª—è–µ—Ç –≤—Å–µ –∑–≤–µ–∑–¥–æ—á–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ
        # –ò—â–µ–º —Ü–µ–Ω—ã > 500, –∏—Å–∫–ª—é—á–∞–µ–º 4/128
        matches = list(re.finditer(r'(?<!/)\b(\d{1,3}(?:[., ]\d{3})*|\d{4,})\b', clean_line)) # –º–∞–≥–∏—è regex, –≤ —Å–ø–∏—Å–∫–æ–≤–æ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏
        
        if not matches: return None

        # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤–∞–ª–∏–¥–Ω–æ–µ —á–∏—Å–ª–æ
        for m in reversed(matches): # –æ–ø—è—Ç—å –º–∞–≥–∏—è
            val_str = re.sub(r'[^\d]', '', m.group(1))
            val = int(val_str)
            
            if 500 < val < 2000000:
                price_str = m.group(1)
                # –î–µ–ª–∏–º —Å—Ç—Ä–æ–∫—É –ø–æ —Ü–µ–Ω–µ (–∏—â–µ–º —Å –∫–æ–Ω—Ü–∞)
                price_idx = line.rfind(price_str)
                if price_idx != -1:
                    return val, line[:price_idx].strip(), line[price_idx + len(price_str):].strip()
        return None

    def _resolve_flag(self, name: str, comment: str, pending: str) -> str: # –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ - —è –Ω–µ –ø–æ–Ω—è–ª
        if pending: return pending # –µ—Å–ª–∏ —Ñ–ª–∞–≥ –≤ –ø–∞–º—è—Ç–∏, —Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ
        
        f = TextExtractor.convert_emoji_to_latin(name) # –∏—â–µ–º —Ñ–ª–∞–≥ –≤ –∏–º–µ–Ω–∏
        if f: return f 
        
        f = TextExtractor.convert_emoji_to_latin(comment) # –∏—â–µ–º —Ñ–ª–∞–≥ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        if f: return f 
        
        return "" # –µ—Å–ª–∏ –Ω–∏–≥–¥–µ –Ω–µ—Ç, —Ç–æ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

    def _clean_text(self, text: str) -> str:
        text = re.sub(r'[\U0001F1E6-\U0001F1FF]{2}', '', text) # –£–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥–∏ –∏–∑ —Ç–µ–∫—Å—Ç–∞, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–ª–∏—Å—å

        if text.strip().endswith('-'): # –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª -
            return text.strip()[:-1].strip() # —É–¥–∞–ª—è–µ—Ç –µ–≥–æ –∏ –ø—Ä–æ–±–µ–ª—ã —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ –≤–æ–∫—Ä—É–≥
        return text.strip()